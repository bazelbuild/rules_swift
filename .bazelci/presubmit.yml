---
x_defaults:
  # YAML has a feature for "repeated nodes", BazelCI is fine with extra nodes
  # it doesn't know about; so that is used to avoid repeating common subparts.
  mac_common: &mac_common
    platform: macos_arm64
    xcode_version: "16.4"
    build_targets:
      - "//examples/..."
    test_targets:
      - "//examples/..."
      - "//test/..."
  linux_environment: &linux_environment
    platform: ubuntu2204
    environment:
      CC: clang
      SWIFT_VERSION: "6.0.3"
      SWIFT_HOME: "$HOME/swift-$SWIFT_VERSION"
      PATH: "$SWIFT_HOME/usr/bin:$PATH"
  linux_common: &linux_common
    <<: *linux_environment
    build_flags: &linux_flags
      # On Linux, we look for Swift toolchain binaries on the path. We may be
      # able to change this when we start auto-downloading toolchains (see
      # https://github.com/bazelbuild/rules_swift/issues/4).
      - "--action_env=PATH"
    build_targets:
      - "//examples/..."
      - "-//examples/apple/..."
    test_flags: *linux_flags
    test_targets:
      - "//examples/..."
      - "//test/..."
      - "-//examples/apple/..."
      # The following tests require Swift >5.8.
      - "-//test:const_values_empty_const_values_multiple_files"
      - "-//test:const_values_empty_const_values_single_file"
      - "-//test:const_values_expected_argv"
      - "-//test:const_values_wmo_single_values_file"
      - "-//test:output_file_map_default"
  windows_common: &windows_common
    platform: windows
    environment:
      SWIFT_VERSION: 6.1.0
      PATH: "%LOCALAPPDATA%\\Programs\\Swift\\Toolchains\\%SWIFT_VERSION%+Asserts\\usr\\bin;%LOCALAPPDATA%\\Programs\\Swift\\Runtimes\\%SWIFT_VERSION%\\usr\\bin;%Path%"
      SDKROOT: "%LOCALAPPDATA%\\Programs\\Swift\\Platforms\\%SWIFT_VERSION%\\Windows.platform\\Developer\\SDKs\\Windows.sdk"
    batch_commands:
      - echo --- Downloading and installing Swift %SWIFT_VERSION%
      - curl.exe -L https://download.swift.org/swift-6.1-release/windows10/swift-6.1-RELEASE/swift-6.1-RELEASE-windows10.exe -o %TEMP%\installer.exe
      - PowerShell Start-Process -FilePath ${env:TEMP}\installer.exe -ArgumentList(\"/install\", \"/passive\", \"/norestart\", \"/log log.txt\") -Wait -PassThru -Verb RunAs
    build_flags:
      # Override 'sandboxed' strategy set in .bazelrc because it's not
      # available on Windows
      - "--strategy=SwiftCompile="
      - "--repo_env=CC=clang-cl"
      # - "--repo_env=SDKROOT=%LOCALAPPDATA%\\Programs\\Swift\\Platforms\\%SWIFT_VERSION%\\Windows.platform\\Developer\\SDKs\\Windows.sdk"
      # - "--repo_env=Path=%LOCALAPPDATA%\\Programs\\Swift\\Toolchains\\%SWIFT_VERSION%+Asserts\\usr\\bin;%LOCALAPPDATA%\\Programs\\Swift\\Runtimes\\%SWIFT_VERSION%\\usr\\bin;%Path%"
    build_targets:
      - "//tools/worker/..."

tasks:
  macos_7:
    name: "Previous LTS with no bzlmod"
    bazel: 7.x
    build_flags:
      - "--noenable_bzlmod"
      - "--enable_workspace"
    <<: *mac_common

  macos_latest:
    name: "Current LTS"
    bazel: latest
    <<: *mac_common

  macos_rolling:
    name: "Latest rolling"
    bazel: rolling
    <<: *mac_common

  macos_last_green:
    name: "Last Green Bazel"
    bazel: last_green
    <<: *mac_common

  macos_latest_head_deps:
    name: "Current LTS with Head Deps"
    bazel: latest
    shell_commands:
    # Update the WORKSPACE to use head versions of some deps to ensure nothing
    # has landed on them breaking this project.
    - .bazelci/update_workspace_to_deps_heads.sh
    <<: *mac_common

  ubuntu2204_7:
    name: "Previous LTS with no bzlmod"
    bazel: 7.x
    shell_commands:
      - "echo --- Downloading and extracting Swift $SWIFT_VERSION to $SWIFT_HOME"
      - "mkdir $SWIFT_HOME"
      - "curl https://download.swift.org/swift-${SWIFT_VERSION}-release/ubuntu2204/swift-${SWIFT_VERSION}-RELEASE/swift-${SWIFT_VERSION}-RELEASE-ubuntu22.04.tar.gz | tar xvz --strip-components=1 -C $SWIFT_HOME"
    build_flags:
      - "--noenable_bzlmod"
      - "--enable_workspace"
    <<: *linux_common

  ubuntu2204_latest:
    name: "Current LTS"
    bazel: latest
    shell_commands:
      - "echo --- Downloading and extracting Swift $SWIFT_VERSION to $SWIFT_HOME"
      - "mkdir $SWIFT_HOME"
      - "curl https://download.swift.org/swift-${SWIFT_VERSION}-release/ubuntu2204/swift-${SWIFT_VERSION}-RELEASE/swift-${SWIFT_VERSION}-RELEASE-ubuntu22.04.tar.gz | tar xvz --strip-components=1 -C $SWIFT_HOME"
    <<: *linux_common

  ubuntu2204_rolling:
    name: "Latest rolling"
    bazel: rolling
    shell_commands:
      - "echo --- Downloading and extracting Swift $SWIFT_VERSION to $SWIFT_HOME"
      - "mkdir $SWIFT_HOME"
      - "curl https://download.swift.org/swift-${SWIFT_VERSION}-release/ubuntu2204/swift-${SWIFT_VERSION}-RELEASE/swift-${SWIFT_VERSION}-RELEASE-ubuntu22.04.tar.gz | tar xvz --strip-components=1 -C $SWIFT_HOME"
    <<: *linux_common

  ubuntu2204_last_green:
    name: "Last Green Bazel"
    bazel: last_green
    shell_commands:
      - "echo --- Downloading and extracting Swift $SWIFT_VERSION to $SWIFT_HOME"
      - "mkdir $SWIFT_HOME"
      - "curl https://download.swift.org/swift-${SWIFT_VERSION}-release/ubuntu2204/swift-${SWIFT_VERSION}-RELEASE/swift-${SWIFT_VERSION}-RELEASE-ubuntu22.04.tar.gz | tar xvz --strip-components=1 -C $SWIFT_HOME"
    <<: *linux_common

  ubuntu2204_latest_head_deps:
    name: "Current LTS with Head Deps"
    bazel: latest
    shell_commands:
      - "echo --- Downloading and extracting Swift $SWIFT_VERSION to $SWIFT_HOME"
      - "mkdir $SWIFT_HOME"
      - "curl https://download.swift.org/swift-${SWIFT_VERSION}-release/ubuntu2204/swift-${SWIFT_VERSION}-RELEASE/swift-${SWIFT_VERSION}-RELEASE-ubuntu22.04.tar.gz | tar xvz --strip-components=1 -C $SWIFT_HOME"
      # Update the WORKSPACE to use head versions of some deps to ensure nothing
      # has landed on them breaking this project.
      - .bazelci/update_workspace_to_deps_heads.sh
    <<: *linux_common

  windows_last_green:
    name: "Latest Bazel"
    bazel: latest
    <<: *windows_common

  doc_tests:
    name: "Doc tests"
    bazel: latest
    <<: *linux_environment
    shell_commands:
      - "echo --- Downloading and extracting Swift $SWIFT_VERSION to $SWIFT_HOME"
      - "mkdir $SWIFT_HOME"
      - "curl https://download.swift.org/swift-${SWIFT_VERSION}-release/ubuntu2204/swift-${SWIFT_VERSION}-RELEASE/swift-${SWIFT_VERSION}-RELEASE-ubuntu22.04.tar.gz | tar xvz --strip-components=1 -C $SWIFT_HOME"
    test_targets:
    - "doc/..."

buildifier: 8.2.1
